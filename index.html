<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IT Interest Calculator — Exact Excel Logic (Multi-payment)</title>
  <style>
    body{font-family:Inter, system-ui, Arial; background:#f4f6f8;color:#102027;margin:0;padding:20px}
    .wrap{max-width:1100px;margin:20px auto}
    .card{background:#fff;border-radius:10px;padding:16px;box-shadow:0 6px 20px rgba(16,32,40,0.06);margin-bottom:16px}
    h1{margin:0 0 8px;font-size:20px}
    label{display:block;font-size:13px;color:#556; margin-bottom:6px}
    input[type="number"], input[type="date"], select{width:100%;padding:8px;border-radius:6px;border:1px solid #e6eef2}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eef3f5;text-align:left;font-size:13px}
    button{background:#0ea5a4;border:0;color:white;padding:8px 10px;border-radius:6px;cursor:pointer}
    .muted{color:#6b7880;font-size:13px}
    .out{background:#f8fafb;border-radius:8px;padding:12px;margin-top:12px}
    .small{font-size:13px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .danger{background:#ef4444}
    .secondary{background:#64748b}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Income-tax Interest Calculator — Exact Excel Logic (Multi-payment)</h1>
      <div class="muted small">This implements the Excel logic: month-or-part rule (ceil days/30), ROUND to nearest ₹100 for 234B base, cumulative payments by date, quarterly 234C rules (3 months for Q1-Q3, 1 month for Q4) and 234F late fee.</div>
    </div>

    <form id="frm">
      <div class="card grid">
        <div>
          <label>Total tax payable (₹)</label>
          <input id="taxPayable" type="number" step="0.01" value="0">
        </div>
        <div>
          <label>TDS / TCS / Other credits (₹)</label>
          <input id="tds" type="number" step="0.01" value="0">
        </div>
        <div>
          <label>Reliefs / MAT / AMT credit (₹)</label>
          <input id="relief" type="number" step="0.01" value="0">
        </div>
      </div>

      <div class="card grid">
        <div>
          <label>Self-assessment tax paid on or before due date (₹)</label>
          <input id="selfTax" type="number" step="0.01" value="0">
        </div>
        <div>
          <label>Total income (for 234F slab) (₹)</label>
          <input id="totalIncome" type="number" step="0.01" value="0">
        </div>
        <div>
          <label>Assessment Year (AY)</label>
          <select id="ay">
            <option value="2024-25">2024-25</option>
            <option value="2025-26">2025-26</option>
            <option value="2026-27">2026-27</option>
          </select>
        </div>
      </div>

      <div class="card grid-2">
        <div>
          <label>Due date of return (under section 139(1))</label>
          <input id="dueReturn" type="date">
        </div>
        <div>
          <label>Actual date of filing return</label>
          <input id="fileReturn" type="date">
        </div>
      </div>

      <div class="card">
        <h3>Advance tax / Other payments (add multiple rows)</h3>
        <div class="muted small">Enter each payment's date and amount. The calculator uses cumulative amounts up to relevant due dates.</div>
        <table id="paymentsTable">
          <thead><tr><th>Date</th><th>Amount (₹)</th><th></th></tr></thead>
          <tbody id="paymentsBody"></tbody>
        </table>
        <div style="margin-top:8px" class="actions">
          <button type="button" id="addPayment">Add payment</button>
          <button type="button" id="clearPayments" class="secondary">Clear payments</button>
        </div>
      </div>

      <div class="card actions">
        <button type="button" id="compute">Compute interest (234A/234B/234C/234F)</button>
        <button type="button" id="download" class="secondary">Download report (CSV)</button>
        <button type="button" id="reset" class="danger">Reset all</button>
      </div>
    </form>

    <div id="output" class="card out" aria-live="polite"></div>
  </div>

  <script>
    // Utilities
    const $ = (id)=>document.getElementById(id);
    function toNum(v){ const n = Number(v); return isNaN(n)?0:n; }
    function fmt(x){ return '₹ ' + Number(x).toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2}); }

    // Round to nearest 100 as Excel ROUND(x,-2)
    function roundNearest100(x){ return Math.round(x/100)*100; }

    function dateISO(d){ if(!d) return null; const dt = new Date(d); if (isNaN(dt)) return null; return dt.toISOString().slice(0,10); }

    // days between a and b -> ceil diff/ (24h) as used earlier
    function daysBetween(a,b){ const A=new Date(a); const B=new Date(b); if (isNaN(A)||isNaN(B)) return NaN; const diff=B.getTime()-A.getTime(); return Math.ceil(diff/(1000*60*60*24)); }
    // months or part thereof between a (exclusive) and b (inclusive) -> ceil(days/30)
    function monthsPart(a,b){ const days = daysBetween(a,b); if (isNaN(days) || days<=0) return 0; return Math.ceil(days/30); }

    // Payments logic
    const payments = [];
    const paymentsBody = $('paymentsBody');

    function renderPayments(){ paymentsBody.innerHTML=''; payments.forEach((p,idx)=>{
      const tr=document.createElement('tr');
      const tdDate=document.createElement('td'); tdDate.textContent = p.date || '';
      const tdAmt=document.createElement('td'); tdAmt.textContent = p.amount ? Number(p.amount).toFixed(2) : '';
      const tdAct=document.createElement('td');
      const btnDel=document.createElement('button'); btnDel.textContent='Remove'; btnDel.style.background='#ef4444'; btnDel.style.color='white'; btnDel.style.border='0'; btnDel.style.padding='6px 8px'; btnDel.style.borderRadius='6px'; btnDel.onclick=()=>{ payments.splice(idx,1); renderPayments(); };
      tdAct.appendChild(btnDel);
      tr.appendChild(tdDate); tr.appendChild(tdAmt); tr.appendChild(tdAct);
      paymentsBody.appendChild(tr);
    }); if(payments.length===0){ const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=3; td.className='muted'; td.textContent='No payments entered'; tr.appendChild(td); paymentsBody.appendChild(tr);} }

    $('addPayment').addEventListener('click', ()=>{
      const date = prompt('Payment date (YYYY-MM-DD)'); if(!date) return; const iso = dateISO(date); if(!iso){ alert('Invalid date'); return; }
      const amtStr = prompt('Amount (₹)'); if(!amtStr) return; const amt = toNum(amtStr); if(amt<=0){ alert('Enter positive amount'); return; }
      payments.push({date:iso, amount:amt});
      // sort by date
      payments.sort((a,b)=> new Date(a.date)-new Date(b.date));
      renderPayments();
    });

    $('clearPayments').addEventListener('click', ()=>{ if(confirm('Clear all payments?')){ payments.length=0; renderPayments(); } });

    $('reset').addEventListener('click', ()=>{
      if(!confirm('Reset all inputs?')) return;
      document.getElementById('frm').reset(); payments.length=0; renderPayments(); $('output').innerHTML='';
    });

    // compute cumulative payments up to a date (inclusive)
    function paidTill(date){ if(!date) return 0; const D=new Date(date); let sum=0; payments.forEach(p=>{ const pd=new Date(p.date); if (!isNaN(pd) && pd.getTime() <= D.getTime()) sum += Number(p.amount); }); return sum; }

    // find date when cumulative payments become >= target; returns date string or null
    function dateWhenCumulativeAtLeast(target){ let cum=0; for(const p of payments){ cum += Number(p.amount); if (cum >= target) return p.date; } return null; }

    // Main compute
    $('compute').addEventListener('click', ()=>{
      const taxPayable = toNum($('taxPayable').value);
      const tds = toNum($('tds').value);
      const relief = toNum($('relief').value);
      const selfTax = toNum($('selfTax').value);
      const totalIncome = toNum($('totalIncome').value);
      const dueReturn = dateISO($('dueReturn').value);
      const fileReturn = dateISO($('fileReturn').value);
      const ay = $('ay').value;

      if(!dueReturn || !fileReturn){ alert('Please enter due date and filing date'); return; }

      // Assessed tax = tax payable - TDS - relief
      let assessedTax = taxPayable - tds - relief; if (assessedTax < 0) assessedTax = 0;

      // Total advance payments irrespective of date
      const totalAdvance = payments.reduce((s,p)=>s+Number(p.amount),0);

      // PAYMENTS considered up to filing date
      const paidUpToFiling = paidTill(fileReturn);

      // 234A: shortfall = assessedTax - (selfTax + paidUpToFiling)
      let short234A = assessedTax - (selfTax + paidUpToFiling); if (short234A < 0) short234A = 0;
      // months from day after due date to filing date
      const dueNext = new Date(dueReturn); dueNext.setDate(dueNext.getDate()+1);
      const months234A = monthsPart(dueNext.toISOString().slice(0,10), fileReturn);
      const int234A = short234A * 0.01 * months234A;

      // 234B: base = round(max(assessedTax - totalAdvance,0), -2)
      let base234B = Math.max(assessedTax - totalAdvance, 0);
      const base234B_rounded = roundNearest100(base234B);
      // months from Apr 1 of AY to filing date
      let ayStartYear = parseInt(ay.split('-')[0],10);
      const ayStart = new Date(ayStartYear,3,1); // April 1
      const months234B = monthsPart(ayStart.toISOString().slice(0,10), fileReturn);
      const int234B = base234B_rounded * 0.01 * months234B;

      // 234C: instalment required percentages applied on assessedTax
      const req1 = assessedTax * 0.15;
      const req2 = assessedTax * 0.45;
      const req3 = assessedTax * 0.75;
      const req4 = assessedTax * 1.00;

      // Determine due dates based on AY selected
      const ayStartYearNum = parseInt(ay.split('-')[0],10);
      const due1 = ayStartYearNum + '-06-15';
      const due2 = ayStartYearNum + '-09-15';
      const due3 = ayStartYearNum + '-12-15';
      const due4 = (ayStartYearNum + 1) + '-03-15';

      // For each instalment compute cumulative paid till that due date
      const paid1 = paidTill(due1);
      const paid2 = paidTill(due2);
      const paid3 = paidTill(due3);
      const paid4 = paidTill(due4);

      const short1 = Math.max(0, req1 - paid1);
      const short2 = Math.max(0, req2 - paid2);
      const short3 = Math.max(0, req3 - paid3);
      const short4 = Math.max(0, req4 - paid4);

      // For each shortfall, find the date when the required cumulative amount was reached (if at all)
      const payDate1 = short1>0 ? (dateWhenCumulativeAtLeast(req1) || fileReturn) : null;
      const payDate2 = short2>0 ? (dateWhenCumulativeAtLeast(req2) || fileReturn) : null;
      const payDate3 = short3>0 ? (dateWhenCumulativeAtLeast(req3) || fileReturn) : null;
      const payDate4 = short4>0 ? (dateWhenCumulativeAtLeast(req4) || fileReturn) : null;

      // months: from day after due date to date when shortfall was made good (or filing date)
      const due1Next = new Date(due1); due1Next.setDate(due1Next.getDate()+1);
      const due2Next = new Date(due2); due2Next.setDate(due2Next.getDate()+1);
      const due3Next = new Date(due3); due3Next.setDate(due3Next.getDate()+1);
      const due4Next = new Date(due4); due4Next.setDate(due4Next.getDate()+1);

      const months1 = short1>0 ? monthsPart(due1Next.toISOString().slice(0,10), payDate1) : 0;
      const months2 = short2>0 ? monthsPart(due2Next.toISOString().slice(0,10), payDate2) : 0;
      const months3 = short3>0 ? monthsPart(due3Next.toISOString().slice(0,10), payDate3) : 0;
      const months4 = short4>0 ? monthsPart(due4Next.toISOString().slice(0,10), payDate4) : 0;

      const int1 = short1 * 0.01 * months1;
      const int2 = short2 * 0.01 * months2;
      const int3 = short3 * 0.01 * months3;
      const int4 = short4 * 0.01 * months4;
      const int234C = int1 + int2 + int3 + int4;

      // 234F late fee: if filed after due date
      let fee234F = 0;
      if (new Date(fileReturn) > new Date(dueReturn)){
        fee234F = totalIncome > 250000 ? 5000 : 1000;
      }

      const totalInterest = int234A + int234B + int234C;

      // Build output
      const out = [];
      out.push('<h2>Computation Summary</h2>');
      out.push('<table>');
      out.push(`<tr><th>Assessed tax (tax - tds - relief)</th><td>${fmt(assessedTax)}</td></tr>`);
      out.push(`<tr><th>Total payments (all dates)</th><td>${fmt(totalAdvance)}</td></tr>`);
      out.push(`<tr><th>Payments up to filing date (${fileReturn})</th><td>${fmt(paidUpToFiling)}</td></tr>`);
      out.push('</table>');

      out.push('<h3>Section 234A — Delay in filing</h3>');
      out.push('<table>');
      out.push(`<tr><th>Shortfall for 234A</th><td>${fmt(short234A)}</td></tr>`);
      out.push(`<tr><th>Months (or part) from day after due date to filing</th><td>${months234A}</td></tr>`);
      out.push(`<tr><th>Interest @1%/month</th><td>${fmt(int234A)}</td></tr>`);
      out.push('</table>');

      out.push('<h3>Section 234B — Default in payment of advance tax</h3>');
      out.push('<table>');
      out.push(`<tr><th>Base (assessed tax - total advance)</th><td>${fmt(base234B)}</td></tr>`);
      out.push(`<tr><th>Base rounded to nearest ₹100</th><td>${fmt(base234B_rounded)}</td></tr>`);
      out.push(`<tr><th>Months from Apr 1 of AY (${ayStart.toISOString().slice(0,10)}) to filing</th><td>${months234B}</td></tr>`);
      out.push(`<tr><th>Interest @1%/month</th><td>${fmt(int234B)}</td></tr>`);
      out.push('</table>');

      out.push('<h3>Section 234C — Deferment of advance tax (quarterly)</h3>');
      out.push('<table>');
      out.push(`<tr><th>Instalment</th><th>Required</th><th>Paid till due</th><th>Shortfall</th><th>Date shortfall cleared</th><th>Months</th><th>Interest</th></tr>`);
      out.push(`<tr><td>1 (15 Jun)</td><td>${fmt(req1)}</td><td>${fmt(paid1)}</td><td>${fmt(short1)}</td><td>${payDate1 || 'Not reached'}</td><td>${months1}</td><td>${fmt(int1)}</td></tr>`);
      out.push(`<tr><td>2 (15 Sep)</td><td>${fmt(req2)}</td><td>${fmt(paid2)}</td><td>${fmt(short2)}</td><td>${payDate2 || 'Not reached'}</td><td>${months2}</td><td>${fmt(int2)}</td></tr>`);
      out.push(`<tr><td>3 (15 Dec)</td><td>${fmt(req3)}</td><td>${fmt(paid3)}</td><td>${fmt(short3)}</td><td>${payDate3 || 'Not reached'}</td><td>${months3}</td><td>${fmt(int3)}</td></tr>`);
      out.push(`<tr><td>4 (15 Mar)</td><td>${fmt(req4)}</td><td>${fmt(paid4)}</td><td>${fmt(short4)}</td><td>${payDate4 || 'Not reached'}</td><td>${months4}</td><td>${fmt(int4)}</td></tr>`);
      out.push(`<tr><th colspan="6">Total 234C interest</th><th>${fmt(int234C)}</th></tr>`);
      out.push('</table>');

      out.push('<h3>Section 234F — Late filing fee</h3>');
      out.push('<table>');
      out.push(`<tr><th>Filing after due date?</th><td>${new Date(fileReturn) > new Date(dueReturn) ? 'Yes' : 'No'}</td></tr>`);
      out.push(`<tr><th>Late fee (234F)</th><td>${fmt(fee234F)}</td></tr>`);
      out.push('</table>');

      out.push('<h3>Grand totals</h3>');
      out.push('<table>');
      out.push(`<tr><th>Total interest (234A + 234B + 234C)</th><td>${fmt(totalInterest)}</td></tr>`);
      out.push(`<tr><th>Late fee (234F)</th><td>${fmt(fee234F)}</td></tr>`);
      out.push(`<tr><th>Payable (interest + fee)</th><td>${fmt(totalInterest + fee234F)}</td></tr>`);
      out.push('</table>');

      $('output').innerHTML = out.join('
');
    });

    // CSV download of payments and summary
    $('download').addEventListener('click', ()=>{
      if(payments.length===0){ alert('No payments to download'); return; }
      let csv = 'date,amount
'; payments.forEach(p=> csv += `${p.date},${Number(p.amount).toFixed(2)}
`);
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'payments.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // initial render
    renderPayments();
  </script>

  <!-- Email Buttons -->
  <div class="email-actions">
    <button id="emailPdfBtn">Email PDF Report</button>
    <button id="emailExcelBtn">Email Excel Report</button>
  </div>

  <script>
    // --- EMAIL REPORT BUTTONS (placeholders for backend integration) ---

    document.getElementById('emailPdfBtn').addEventListener('click', () => {
      alert('PDF email functionality will connect to your backend API.');
      // Example: sendReport('pdf');
    });

    document.getElementById('emailExcelBtn').addEventListener('click', () => {
      alert('Excel email functionality will connect to your backend API.');
      // Example: sendReport('excel');
    });

    // --- Example structure for backend call ---
    function sendReport(type) {
      fetch('/send-report', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ format: type, data: collectReportData() })
      })
      .then(r => r.json())
      .then(res => alert(res.message));
    }

    // --- Example harvest function (can be expanded) ---
    function collectReportData() {
      return {
        taxableIncome: document.getElementById('taxableIncome')?.value || '',
        payments: getPaymentRows?.() || [],
        results: document.getElementById('resultSection')?.innerText || ''
      };
    }
  </script>
</body>
</html>
